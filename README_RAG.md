# RAG同步功能说明

## 功能概述

RAG同步功能允许将上传的文件同步到RAGFlow知识库中，实现文档的智能检索和分析。

## 主要功能

### 1. RAG配置页面
- **位置**: 左侧导航栏 → API接口测试 → RAG配置
- **功能**: 
  - 配置RAG API地址和密钥
  - 选择目标知识库
  - 选择同步方式
  - 测试RAG连接
  - 查看同步统计

### 2. 文件同步功能
- **支持的文件类型**: 所有上传的文件（项目文件、简历、公司介绍、工作条件、知识纪要）
- **同步按钮**: 每个文件卡片都有"同步到RAG"按钮
- **同步状态**: 显示待同步、同步中、已同步、同步失败等状态

### 3. 同步方式选择
系统提供五种同步方式：

#### 方式1：直接从服务器加载（推荐）
- **优点**: 效率最高，无网络传输，直接从服务器文件系统读取
- **原理**: 直接使用 `files` 集合中的 `file_path` 字段，向RAG API发送服务器文件路径
- **适用场景**: RAG API支持服务器路径方式上传，文件已存储在服务器上
- **数据来源**: 直接从 `files` 集合的 `file_path` 字段获取文件实际路径
- **回退机制**: 如果RAG API不支持服务器路径方式（返回"No file part!"错误），自动回退到下载方式

#### 方式2：直接使用文件链接
- **优点**: 效率高，不占用额外带宽，适合大文件
- **原理**: 直接向RAG API发送文件下载链接
- **适用场景**: RAG API支持URL方式上传

#### 方式3：下载后上传（兼容性更好）
- **优点**: 兼容性最好，适用于所有RAG API
- **原理**: 先下载文件内容，再上传到RAG
- **适用场景**: RAG API只支持文件上传

#### 方式4：智能同步
- **优点**: 自动处理解析问题，成功率最高
- **原理**: 先尝试URL方式，失败则下载，并尝试触发文件解析
- **适用场景**: 需要确保文件被正确解析的场景

#### 方式5：自动选择（默认）
- **优点**: 智能选择最佳方式
- **原理**: 先尝试URL方式，失败则回退到下载方式
- **适用场景**: 不确定RAG API支持哪种方式时

### 4. 批量同步
- 在RAG配置页面可以一键同步所有文件
- 显示同步统计信息（总文件数、已同步、同步失败）

## 使用步骤

### 1. 配置RAG API
1. 打开RAG配置页面
2. 输入RAG API地址（默认: http://localhost/api/v1）
3. 输入API密钥
4. 选择同步方式（推荐使用"自动选择"）
5. 点击"保存配置"

### 2. 选择知识库
1. 点击"刷新列表"加载知识库
2. 从列表中选择目标知识库
3. 系统会自动保存选择

### 3. 同步文件
- **单个文件同步**: 在文件列表中点击"同步到RAG"按钮
- **批量同步**: 在RAG配置页面点击"同步所有文件"

## API接口

### 后端API
- `PUT /api/files/<file_id>/sync-status` - 更新文件同步状态
- `GET /api/files/<file_id>/download` - 文件下载接口
- `GET /api/files/<file_id>/info` - 获取文件详细信息（包含原始文件名）
- `GET /api/files/<file_id>/server-path` - 获取文件在服务器上的路径信息（从files集合的file_path字段）
- 文件文档字段说明:
  - `file_path`: 文件在服务器上的实际存储路径
  - `original_filename`: 原始文件名（用于RAG同步）
  - `sync_status`: 同步状态 (pending/processing/completed/failed)
  - `sync_enabled`: 是否启用同步
  - `sync_result`: 同步结果
  - `sync_error`: 同步错误信息
  - `sync_date`: 同步完成时间

### RAG API
- `GET /datasets` - 获取知识库列表
- `POST /datasets/<dataset_id>/documents` - 上传文档到知识库
  - 支持文件上传方式
  - 支持URL方式（如果RAG API支持）
  - 支持服务器路径方式（如果RAG API支持）
  - 使用原始文件名确保文件在RAG中显示正确的名称

## 配置说明

### RAG API配置
- **API地址**: RAGFlow服务的API地址
- **API密钥**: 用于认证的API密钥
- **知识库ID**: 目标知识库的唯一标识
- **同步方式**: 选择最适合的同步方式

### 同步状态
- **pending**: 待同步
- **processing**: 同步中
- **completed**: 已同步
- **failed**: 同步失败

## 性能优化

### 同步方式对比

| 方式 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| 服务器路径 | 效率最高，无网络传输 | 依赖RAG API支持 | RAG API支持服务器路径 |
| 文件链接 | 效率高，带宽占用少 | 依赖RAG API支持 | RAG API支持URL上传 |
| 下载上传 | 兼容性最好 | 占用额外带宽 | 所有RAG API |
| 智能同步 | 智能选择 | 需要多次尝试 | 不确定API支持情况 |
| 自动选择 | 智能选择 | 需要两次尝试 | 不确定API支持情况 |

### 推荐配置
- **开发环境**: 使用"自动选择"方式
- **生产环境**: 根据RAG API支持情况选择最佳方式
- **大文件场景**: 优先使用"文件链接"方式

## 注意事项

1. 确保RAGFlow服务正在运行
2. 确保API密钥有效且有足够权限
3. 大文件同步可能需要较长时间
4. 同步失败时会显示具体错误信息
5. 配置信息会保存在浏览器本地存储中
6. 不同同步方式对网络和服务器资源要求不同

### 故障排除

#### 常见问题

1. **"No file part!"错误**
   - **现象**: RAG API返回 `{code: 101, message: 'No file part!'}`
   - **原因**: RAG API不支持JSON方式上传（URL或服务器路径）
   - **解决**: 系统会自动回退到下载方式上传，无需手动干预
   - **建议**: 使用"下载后上传"方式或"自动选择"方式

2. **文件同步成功但RAG知识库中看不到**
   - **检查**: 确认RAG API配置正确
   - **检查**: 确认知识库ID正确
   - **检查**: 查看浏览器控制台日志，确认文件是否真正上传成功
   - **尝试**: 使用"智能同步"方式，包含自动解析功能

3. **文件下载失败**
   - **检查**: 确认文件在服务器上存在
   - **检查**: 确认文件路径正确
   - **尝试**: 使用"直接从服务器加载"方式

4. **RAG API连接失败**
   - **检查**: 确认RAG API地址正确
   - **检查**: 确认API密钥有效
   - **测试**: 使用"测试连接"功能验证配置

### 调试方法
1. 打开浏览器开发者工具查看网络请求
2. 检查后端日志获取详细错误信息
3. 使用"测试连接"功能验证API配置
4. 使用"测试文档上传"功能验证上传格式
5. 尝试不同的同步方式
6. 查看控制台日志了解同步过程

### 性能优化建议
1. 对于大文件，优先使用文件链接方式
2. 批量同步时建议使用自动选择方式
3. 网络不稳定时使用下载上传方式
4. 定期清理同步失败的文件记录 